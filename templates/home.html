<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil</title>
</head>
<body>
    <h1>Bienvenue sur AIChessMate</h1>
    {% if user.is_authenticated %}
        <p>Connect√© en tant que : {{ user.username }}</p>
        <a href="{% url 'logout' %}">Se d√©connecter</a>
    {% endif %}

    <button id="search-game">Rechercher une partie</button>
    <p id="status"></p>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const socketUrl = `${protocol}://${window.location.host}/ws/matchmaking/`;
            const socket = new WebSocket(socketUrl);

            const searchBtn = document.getElementById("search-game");
            const statusText = document.getElementById("status");

            let isSearching = false;

            socket.onopen = () => {
                console.log("‚úÖ Connexion WebSocket matchmaking √©tablie");
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log("üì© Message re√ßu :", data);

                if (data.action === "waiting") {
                    statusText.textContent = "En attente d‚Äôun adversaire...";
                } else if (data.action === "match_found") {
                    statusText.textContent = `Partie trouv√©e ! Vous √™tes les ${data.role}`;
                    window.location.href = `/game/${data.game_id}/`;
                } else if (data.action === "left_queue") {
                    statusText.textContent = "Recherche annul√©e.";
                    searchBtn.textContent = "Rechercher une partie";
                    isSearching = false;
                }
            };

            socket.onclose = () => {
                console.warn("üîå WebSocket matchmaking ferm√©");
                if (isSearching) {
                    statusText.textContent = "Connexion perdue.";
                    searchBtn.textContent = "Rechercher une partie";
                    isSearching = false;
                }
            };

            searchBtn.addEventListener("click", () => {
                if (socket.readyState !== WebSocket.OPEN) {
                    console.warn("WebSocket non pr√™t !");
                    return;
                }

                if (!isSearching) {
                    socket.send(JSON.stringify({ action: "search" }));
                    statusText.textContent = "Recherche en cours...";
                    searchBtn.textContent = "Annuler la recherche";
                    isSearching = true;
                } else {
                    socket.send(JSON.stringify({ action: "leave_queue" }));
                    statusText.textContent = "Annulation en cours...";
                    searchBtn.textContent = "Rechercher une partie";
                    isSearching = false;
                }
            });
        });
    </script>
</body>
</html>